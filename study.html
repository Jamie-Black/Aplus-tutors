<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="study.css">
  <title>Aplus Tutors | Study Page</title>
  

</head>
<body>
  <header>
    <div style="display:flex;flex-direction:column;">
      <h1>Aplus Tutors</h1>
      <div style="font-size: 11px;" class="sub">... guaranteed success</div>
    </div>
    <div style="margin-left:auto;font-size:13px;color:#fff;opacity:0.95">
      <div id="studentName">Student</div>
      <div style="font-size:12px;margin-top:4px">Completion: <span id="overallPct">0%</span></div>
    </div>
  </header>

  <main>
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">Subjects</div>
        <div style="font-size:13px;color:#666">Tap a subject to view topics</div>
      </div>
      <div class="subjects-row" id="subjectsRow" role="tablist" aria-label="Subjects"></div>
    </div>

    <div class="topics-panel" id="topicsPanel" aria-live="polite"></div>

    <div class="notes-card" id="notesCard" tabindex="0" aria-live="polite">
      <div id="notesPlaceholder" style="text-align:center;color:#888;padding:36px 10px">
        <div style="font-weight:700">No topic selected</div>
        <div style="margin-top:6px">Pick a subject and a topic to start studying.</div>
      </div>

      <div id="notesContent" style="display:none">
        <div class="notes-header">
          <div>
            <div class="breadcrumb" id="breadcrumb">—</div>
            <div class="note-title" id="noteTitle"></div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end">
            <div style="font-size:12px;color:#666">Reading progress</div>
            <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
              <div class="progress-bar" style="width:160px">
                <div id="noteProgress" class="progress-inner"></div>
              </div>
              <div class="progress-label" id="notePct">0%</div>
            </div>
          </div>
        </div>

        <div style="line-height: 1.5rem;" id="noteBody"></div>

        <div class="controls">
          <button id="markDoneBtn" class="btn primary">Mark as Done</button>
          <button id="backToTopics" class="btn ghost">Back to Topics</button>
        </div>
      </div>
    </div>
  </main>

  <footer style="text-align:center;padding:12px;color:white;font-size:13px; background-color:#8B0000;">
    <div style="padding: 10px;">
      <a style="text-decoration: underline; color: white;" class="btn" href="dashboard.html">Back to Dashboard</a>
    </div>
    <h4>&copy; 2021 Aplus Tutors</h4>
</footer>

  <script src="studydata.js"></script>
<script>
  const LS_COMPLETED = 'aplus_completed_topics_v2';
  const LS_PROGRESS = 'aplus_topic_progress_v2';

  const subjectsRow = document.getElementById('subjectsRow');
  const topicsPanel = document.getElementById('topicsPanel');
  const notesCard = document.getElementById('notesCard');
  const notesPlaceholder = document.getElementById('notesPlaceholder');
  const notesContent = document.getElementById('notesContent');
  const noteTitle = document.getElementById('noteTitle');
  const noteBody = document.getElementById('noteBody');
  const breadcrumb = document.getElementById('breadcrumb');
  const noteProgressEl = document.getElementById('noteProgress');
  const notePct = document.getElementById('notePct');
  const overallPct = document.getElementById('overallPct');
  const markDoneBtn = document.getElementById('markDoneBtn');
  const backToTopics = document.getElementById('backToTopics');
  const studentNameEl = document.getElementById('studentName');

  // Add next topic button dynamically
  const nextTopicBtn = document.createElement('button');
  nextTopicBtn.className = 'btn secondary';
  nextTopicBtn.textContent = 'Next Topic ➜';
  document.querySelector('.controls').appendChild(nextTopicBtn);

  let completed = JSON.parse(localStorage.getItem(LS_COMPLETED) || '{}');
  let progressStore = JSON.parse(localStorage.getItem(LS_PROGRESS) || '{}');

  let currentSubject = null;
  let currentTopic = null;

  const loggedUser = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
  if (loggedUser && loggedUser.fullName) studentNameEl.textContent = loggedUser.fullName;

  const keyFor = (subject, topic) => `${subject}||${topic}`;

  // ========== SUBJECT RENDERING ==========

  function renderSubjects() {
  subjectsRow.innerHTML = '';
  
  // Get department of logged-in user
  const userDept = loggedUser?.department;
  
  let subjects = [];
  
  if (userDept && departmentSubjects[userDept]) {
    // Filter only subjects for the user’s department
    subjects = departmentSubjects[userDept].filter(sub => studyData[sub]);
  } else {
    // Fallback: show ALL subjects in studyData
    subjects = Object.keys(studyData);
  }
  
  // Render subject pills
  subjects.forEach((s, i) => {
    const btn = document.createElement('button');
    btn.className = 'subject-pill' + (i === 0 ? ' active' : '');
    btn.textContent = s;
    btn.onclick = () => selectSubject(s, btn);
    subjectsRow.appendChild(btn);
  });
  
  if (subjects.length) selectSubject(subjects[0], subjectsRow.children[0]);
  
  updateOverall();
}


  function selectSubject(subject, el) {
    Array.from(subjectsRow.children).forEach(b => b.classList.remove('active'));
    if (el) el.classList.add('active');

    currentSubject = subject;
    renderTopics(subject);

    notesPlaceholder.style.display = 'block';
    notesContent.style.display = 'none';
  }

  // ========== TOPIC RENDERING ==========

  function renderTopics(subject) {
    topicsPanel.innerHTML = '';

    const topics = studyData[subject] || [];

    topics.forEach(t => {
      const row = document.createElement('div');
      row.className = 'topic-row';

      const left = document.createElement('div');
      left.className = 'topic-left';
      left.innerHTML = `
        <div class="topic-title">${t.topic}</div>
        <div class="topic-meta">${(t.notes.content || []).length} blocks</div>
      `;

      const right = document.createElement('div');
      const key = keyFor(subject, t.topic);
      const done = !!completed[key];

      if (done) {
        const badge = document.createElement('span');
        badge.className = 'badge-completed';
        badge.textContent = 'Done';
        right.appendChild(badge);
      }

      const openBtn = document.createElement('button');
      openBtn.className = 'open-btn';
      openBtn.textContent = 'Open';
      openBtn.onclick = () => openTopic(subject, t);

      right.appendChild(openBtn);

      row.appendChild(left);
      row.appendChild(right);

      topicsPanel.appendChild(row);
    });
  }

  // ========== OPEN TOPIC WITH NEW STRUCTURE ==========

  function openTopic(subject, topicObj) {
    currentSubject = subject;
    currentTopic = topicObj;

    breadcrumb.textContent = `${subject} → ${topicObj.topic}`;
    noteTitle.textContent = topicObj.notes.title || topicObj.topic;

    noteBody.innerHTML = '';

    (topicObj.notes.content || []).forEach((block, i) => {
      const container = document.createElement('div');
      container.className = 'note-block';

      if (block.type === 'text') {
        const p = document.createElement('p');
        p.innerHTML = block.data.replace(/\n/g, '<br>');
        container.appendChild(p);
      }

      if (block.type === 'image') {
        const img = document.createElement('img');
        img.src = block.data;
        img.alt = topicObj.topic + ' image ' + (i + 1);
        img.style.maxWidth = '100%';
        container.appendChild(img);
      }

      noteBody.appendChild(container);
    });

    notesPlaceholder.style.display = 'none';
    notesContent.style.display = 'block';

    notesCard.classList.add('enter-from-right');
    requestAnimationFrame(() => notesCard.classList.remove('enter-from-right'));

    const k = keyFor(subject, topicObj.topic);
    setNoteProgress(progressStore[k] || 0);

    notesCard.scrollTop = 0;
    notesCard.removeEventListener('scroll', onNotesScroll);
    notesCard.addEventListener('scroll', onNotesScroll);

    markDoneBtn.onclick = () => markAsDone(k);

    backToTopics.onclick = () => {
      notesContent.style.display = 'none';
      notesPlaceholder.style.display = 'block';
      currentTopic = null;
    };

    nextTopicBtn.onclick = () => goToNextTopic();

    renderTopics(currentSubject);

    setTimeout(() => {
      notesCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }

  // ========== NEXT TOPIC ==========

  function goToNextTopic() {
    if (!currentSubject || !currentTopic) return;

    const topics = studyData[currentSubject];
    const i = topics.findIndex(t => t.topic === currentTopic.topic);
    const next = topics[i + 1];

    if (next) openTopic(currentSubject, next);
    else alert("You've reached the last topic!");
  }

  // ========== SCROLL PROGRESS ==========

  function onNotesScroll() {
    if (!currentSubject || !currentTopic) return;

    const max = notesCard.scrollHeight - notesCard.clientHeight;
    const pct = max > 0 ? Math.round((notesCard.scrollTop / max) * 100) : 100;

    setNoteProgress(pct);

    const key = keyFor(currentSubject, currentTopic.topic);
    progressStore[key] = pct;
    localStorage.setItem(LS_PROGRESS, JSON.stringify(progressStore));

    if (pct >= 95) markAsDone(key);
  }

  function setNoteProgress(pct) {
    noteProgressEl.style.width = pct + '%';
    notePct.textContent = pct + '%';
  }

  // ========== MARK AS DONE ==========

  function markAsDone(key) {
    completed[key] = true;
    progressStore[key] = 100;

    localStorage.setItem(LS_COMPLETED, JSON.stringify(completed));
    localStorage.setItem(LS_PROGRESS, JSON.stringify(progressStore));

    renderTopics(currentSubject);
    updateOverall();
    setNoteProgress(100);

    setTimeout(() => alert('Marked as completed ✅'), 80);
  }

  // ========== OVERALL PROGRESS ==========

  function updateOverall() {
    let total = 0, done = 0;

    Object.keys(studyData).forEach(subject => {
      (studyData[subject] || []).forEach(t => {
        total++;
        if (completed[keyFor(subject, t.topic)]) done++;
      });
    });

    overallPct.textContent = total ? Math.round((done / total) * 100) + '%' : '0%';
  }

  // ========== INIT ==========

  if (window.studyData) {
    renderSubjects();
  } else {
    topicsPanel.innerHTML =
      '<div style="padding:12px;color:#666">No study data found.</div>';
  }

</script>
</body>
</html>