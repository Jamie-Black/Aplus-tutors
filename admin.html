<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aplus Tutors | Admin Dashboard</title>

<style>
:root {
  --primary: #8B0000;
  --secondary: #f9f9f9;
  --text: #333;
  --card-bg: #fff;
  --shadow: rgba(0,0,0,0.1);
}

body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--secondary);
  color: var(--text);
}

header {
  background: var(--primary);
  color: #fff;
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 6px var(--shadow);
}

header h1 { margin: 0; font-size: 1.6rem; }

main { padding: 20px; max-width: 1200px; margin: 0 auto; }

.stats {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.stat-card {
  flex: 1 1 180px;
  background: var(--card-bg);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  box-shadow: 0 4px 10px var(--shadow);
  transition: transform 0.2s;
}

.stat-card:hover { transform: translateY(-3px); }

.stat-card h3 {
  margin: 0 0 10px;
  font-size: 1rem;
  color: var(--primary);
}

.stat-card p {
  font-size: 1.4rem;
  font-weight: bold;
  margin: 0;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: var(--card-bg);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 10px var(--shadow);
  margin-bottom: 20px;
}

th, td { padding: 12px 10px; text-align: left; }
th { background: var(--primary); color: #fff; }
tr:nth-child(even) { background: #f2f2f2; }

footer {
  background: var(--primary);
  color: #fff;
  padding: 14px 0;
  text-align: center;
}

footer button {
  background: #fff;
  color: var(--primary);
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  margin-top: 8px;
}

footer button:hover { opacity: 0.9; }

#loading {
  text-align: center;
  margin: 30px 0;
}

#loading span {
  display: inline-block;
  width: 12px;
  height: 12px;
  margin: 0 5px;
  background: var(--primary);
  border-radius: 50%;
  animation: bounce 0.6s infinite alternate;
}

#loading span:nth-child(2) { animation-delay: 0.2s; }
#loading span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce { to { transform: translateY(-10px); } }

button.load-more {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
  display: block;
  margin: 0 auto 30px;
  font-weight: bold;
  transition: opacity 0.2s;
}

button.load-more:hover { opacity: 0.9; }
</style>
</head>
<body>

<header>
  <h1>ðŸ“Š Admin Dashboard</h1>
  <div>Welcome, <strong id="adminName"></strong></div>
</header>

<main>
  <section class="stats">
    <div class="stat-card"><h3>Total Logins</h3><p id="totalLogins">0</p></div>
    <div class="stat-card"><h3>Successful Logins</h3><p id="successLogins">0</p></div>
    <div class="stat-card"><h3>Failed Logins</h3><p id="failedLogins">0</p></div>
    <div class="stat-card"><h3>Currently Online</h3><p id="activeUsers">0</p></div>
  </section>

  <div id="loading">
    <span></span><span></span><span></span>
  </div>

  <section>
    <table>
      <thead>
        <tr>
          <th>Date/Time</th>
          <th>Email</th>
          <th>Department</th>
          <th>Role</th>
          <th>Event</th>
        </tr>
      </thead>
      <tbody id="eventsTableBody"></tbody>
    </table>
    <button class="load-more" id="loadMoreBtn">Load More</button>
  </section>
</main>

<footer>
  &copy; 2026 Aplus Tutors
  <br>
  <button id="logoutBtn">Logout</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyBSr__wqMxY_IL7LXsO9P1LpJDiDAQNsmE",
  authDomain: "aplus-tutors-765bf.firebaseapp.com",
  projectId: "aplus-tutors-765bf",
  storageBucket: "aplus-tutors-765bf.app",
  messagingSenderId: "387214060287",
  appId: "1:387214060287:web:d6213f9c2624f029c0baca",
  measurementId: "G-41V5ZZDH1V"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Check logged in user role ---
const loggedUser = JSON.parse(localStorage.getItem("loggedInUser") || "null");

if (!loggedUser || loggedUser.role !== "Admin") {
  alert("Access denied: Admins only");
  window.location.href = "student-login.html";
} else {
  document.getElementById("adminName").textContent = loggedUser.email;
}

// --- DOM Elements ---
const totalEl = document.getElementById("totalLogins");
const successEl = document.getElementById("successLogins");
const failEl = document.getElementById("failedLogins");
const activeEl = document.getElementById("activeUsers");
const tbody = document.getElementById("eventsTableBody");
const loadingEl = document.getElementById("loading");

// --- Real-time events listener ---
let eventsData = [];

function listenEvents() {
  const q = query(collection(db, "events"), orderBy("timestamp", "desc"));
  onSnapshot(q, snapshot => {
    eventsData = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        email: data.user || "Unknown",
        department: data.department || "Unknown",
        role: data.role || "Unknown",
        event: data.event || "Unknown",
        timestamp: data.timestamp?.toDate?.()?.toISOString() || null
      };
    });

    renderTable();
    renderStats();
    loadingEl.style.display = "none";
  }, err => {
    console.error("Error fetching events:", err);
    alert("âš ï¸ Could not fetch events. Check Firestore rules.");
    loadingEl.style.display = "none";
  });
}

// --- Render table ---
function renderTable() {
  tbody.innerHTML = "";
  eventsData.forEach(ev => {
    const ts = ev.timestamp ? new Date(ev.timestamp).toLocaleString() : "Unknown";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ts}</td>
      <td>${ev.email}</td>
      <td>${ev.department}</td>
      <td>${ev.role}</td>
      <td>${ev.event}</td>
    `;
    tbody.appendChild(tr);
  });
}

// --- Render stats ---
function renderStats() {
  const total = eventsData.length;
  const success = eventsData.filter(e => e.event === "login_success").length;
  const failure = eventsData.filter(e => e.event === "login_failure").length;

  const now = new Date();
  const active = eventsData.filter(e => {
    if (!e.timestamp) return false;
    const ts = new Date(e.timestamp);
    return e.event === "login_success" && ts > new Date(now - 15 * 60000);
  }).length;

  totalEl.textContent = total;
  successEl.textContent = success;
  failEl.textContent = failure;
  activeEl.textContent = active;
}

// --- Logout ---
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("loggedInUser");
  localStorage.removeItem("userDepartment");
  alert("You have been logged out.");
  window.location.href = "student-login.html";
});

// --- Start listening ---
listenEvents();
</script>

</body>
</html>