<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aplus Tutors | Admin Dashboard</title>
<link rel="stylesheet" href="admin.css">
</head>
<body>

<header>
  <h1>ðŸ“Š Admin Dashboard</h1>
  <div>Welcome, <strong id="adminName"></strong></div>
</header>

<main>
  <section class="stats">
    <div class="stat-card"><h3>Total Logins</h3><p id="totalLogins">0</p></div>
    <div class="stat-card"><h3>Successful Logins</h3><p id="successLogins">0</p></div>
    <div class="stat-card"><h3>Failed Logins</h3><p id="failedLogins">0</p></div>
    <div class="stat-card"><h3>Currently Online</h3><p id="activeUsers">0</p></div>
  </section>

  <div id="loading">
    <span></span><span></span><span></span>
  </div>

<section>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Date/Time</th>
          <th>Email</th>
          <th>Department</th>
          <th>Role</th>
          <th>Event</th>
        </tr>
      </thead>
      <tbody id="eventsTableBody"></tbody>
    </table>
  </div>
</section>

</main>

<footer>
  &copy; 2026 Aplus Tutors
  <br>
  <button id="logoutBtn">Logout</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyBSr__wqMxY_IL7LXsO9P1LpJDiDAQNsmE",
  authDomain: "aplus-tutors-765bf.firebaseapp.com",
  projectId: "aplus-tutors-765bf",
  storageBucket: "aplus-tutors-765bf.app",
  messagingSenderId: "387214060287",
  appId: "1:387214060287:web:d6213f9c2624f029c0baca",
  measurementId: "G-41V5ZZDH1V"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Check logged in user role ---
const loggedUser = JSON.parse(localStorage.getItem("loggedInUser") || "null");

if (!loggedUser || loggedUser.role !== "Admin") {
  alert("Access denied: Admins only");
  window.location.href = "student-login.html";
} else {
  document.getElementById("adminName").textContent = loggedUser.email;
}

// --- DOM Elements ---
const totalEl = document.getElementById("totalLogins");
const successEl = document.getElementById("successLogins");
const failEl = document.getElementById("failedLogins");
const activeEl = document.getElementById("activeUsers");
const tbody = document.getElementById("eventsTableBody");
const loadingEl = document.getElementById("loading");

// --- Real-time events listener ---
let eventsData = [];

function listenEvents() {
  const q = query(collection(db, "events"), orderBy("timestamp", "desc"));
  onSnapshot(q, snapshot => {
    eventsData = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        email: data.user || "Unknown",
        department: data.department || "Unknown",
        role: data.role || "Unknown",
        event: data.event || "Unknown",
        timestamp: data.timestamp?.toDate?.()?.toISOString() || null
      };
    });

    renderTable();
    renderStats();
    loadingEl.style.display = "none";
  }, err => {
    console.error("Error fetching events:", err);
    alert("âš ï¸ Could not fetch events. Check Firestore rules.");
    loadingEl.style.display = "none";
  });
}

// --- Render table ---
function renderTable() {
  tbody.innerHTML = "";
  eventsData.forEach(ev => {
    const ts = ev.timestamp ? new Date(ev.timestamp).toLocaleString() : "Unknown";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ts}</td>
      <td>${ev.email}</td>
      <td>${ev.department}</td>
      <td>${ev.role}</td>
      <td>${ev.event}</td>
    `;
    tbody.appendChild(tr);
  });
}

// --- Render stats ---
function renderStats() {
  const total = eventsData.length;
  const success = eventsData.filter(e => e.event === "login_success").length;
  const failure = eventsData.filter(e => e.event === "login_failure").length;

  const now = new Date();
  const active = eventsData.filter(e => {
    if (!e.timestamp) return false;
    const ts = new Date(e.timestamp);
    return e.event === "login_success" && ts > new Date(now - 15 * 60000);
  }).length;

  totalEl.textContent = total;
  successEl.textContent = success;
  failEl.textContent = failure;
  activeEl.textContent = active;
}

// --- Logout ---
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("loggedInUser");
  localStorage.removeItem("userDepartment");
  alert("You have been logged out.");
  window.location.href = "student-login.html";
});

// --- Start listening ---
listenEvents();
</script>

</body>
  </html>
