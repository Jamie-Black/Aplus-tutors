<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aplus Tutors | Unified Progress Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<link rel="stylesheet" href="progress.css">
</head>

<body>

<header>
  <h1>üìä My Progress Dashboard</h1>
  <p style="color:#ffe6e6;margin-top:5px;">
    All your study, quizzes, and CBT records in one place
  </p>
</header>

<main>

  <div class="tabs">
    <button class="tab active" onclick="showSection('study')">Study</button>
    <button class="tab" onclick="showSection('quiz')">Quizzes</button>
    <button class="tab" onclick="showSection('cbt')">CBT Tests</button>
  </div>

  <!-- ================= STUDY ================= -->
  <section id="studySection" class="content-section active">
    <h2>Study Progress (Grouped by Subject)</h2>

    <div class="summary-container" id="studySummary"></div>

    <div class="table-wrapper">
      <table id="studyTable">
        <thead>
          <tr>
            <th>Topic</th>
            <th>Progress</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ================= QUIZ ================= -->
  <section id="quizSection" class="content-section">
    <h2>Quizzes</h2>

    <div class="summary-container" id="quizSummary"></div>

    <div class="chart-container">
      <canvas id="quizChart"></canvas>
    </div>

    <div class="table-wrapper">
      <table id="quizTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Score</th>
            <th>Total</th>
            <th>Percentage</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ================= CBT ================= -->
  <section id="cbtSection" class="content-section">
    <h2>CBT Tests</h2>

    <div class="summary-container" id="cbtSummary"></div>

    <div class="chart-container">
      <canvas id="cbtChart"></canvas>
    </div>

    <div class="table-wrapper">
      <table id="cbtTable">
        <thead>
          <tr>
            <th>Subject(s)</th>
            <th>Score</th>
            <th>Total</th>
            <th>Percentage</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</main>

<footer>
  <button onclick="clearAllRecords()">Clear All Records</button>
  <button onclick="downloadPDF()">Download PDF</button>

  <a href="dashboard.html"
     style="flex:1 1 180px;padding:12px;border:none;border-radius:8px;
            font-weight:bold;text-align:center;color:white;
            background-color:#8B0000;text-decoration:none;
            display:flex;justify-content:center;align-items:center;">
    Back to Dashboard
  </a>
</footer>

<!-- STUDY DATA -->
<script src="studydata.js"></script>

<script>
/* ================= AUTH ================= */
const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
if (!loggedInUser) location.href = "student-login.html";

const user = loggedInUser;
const userDept = user?.department;

/* ================= TABS ================= */
function showSection(type){
  document.querySelectorAll(".content-section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.getElementById(type + "Section").classList.add("active");
  document.querySelectorAll(".tab")[["study","quiz","cbt"].indexOf(type)].classList.add("active");
}

/* ================= STORAGE ================= */
const completedTopics = JSON.parse(localStorage.getItem("aplus_completed_topics_v2") || "{}");
const topicProgress  = JSON.parse(localStorage.getItem("aplus_topic_progress_v2") || "{}");

const quizzes = JSON.parse(localStorage.getItem("quizResults") || "[]")
  .filter(q => !q.email || q.email === user.email);

const cbts = JSON.parse(localStorage.getItem("cbtResults") || "[]")
  .filter(c => !c.email || c.email === user.email);

/* ================= STUDY (FIXED & MATCHES STUDY PAGE) ================= */
function renderStudy() {
  const tbody = document.querySelector("#studyTable tbody");
  tbody.innerHTML = "";

  let subjects = [];
  let total = 0;
  let completed = 0;

  // üîë EXACT SAME LOGIC AS STUDY PAGE
  if (userDept && window.departmentSubjects && departmentSubjects[userDept]) {
    subjects = departmentSubjects[userDept].filter(
      sub => Array.isArray(studyData[sub])
    );
  } else {
    subjects = Object.keys(studyData);
  }

  if (!subjects.length) {
    document.getElementById("studySummary").innerHTML =
      "<p style='color:#666'>No study data available</p>";
    return;
  }

  subjects.forEach(subject => {
    const topics = studyData[subject] || [];
    if (!topics.length) return;

    tbody.innerHTML += `
      <tr class="subject-group-row">
        <td colspan="3"><strong>${subject}</strong></td>
      </tr>
    `;

    topics.forEach(t => {
      const topicTitle = t.topic;
      const key = `${subject}||${topicTitle}`;

      total++;
      if (completedTopics[key]) completed++;

      tbody.innerHTML += `
        <tr class="${completedTopics[key] ? 'completed-row' : ''}">
          <td>${topicTitle}</td>
          <td>${topicProgress[key] || 0}%</td>
          <td>${completedTopics[key] ? '‚úÖ Completed' : '‚è≥ In Progress'}</td>
        </tr>
      `;
    });
  });

  document.getElementById("studySummary").innerHTML = `
    <div class="summary-card"><h3>Total Topics</h3><p>${total}</p></div>
    <div class="summary-card"><h3>Completed</h3><p>${completed}</p></div>
    <div class="summary-card"><h3>Overall</h3>
      <p>${total ? Math.round((completed / total) * 100) : 0}%</p>
    </div>
  `;
}

/* ================= QUIZ ================= */
function renderQuiz(){
  const tbody = document.querySelector("#quizTable tbody");
  tbody.innerHTML = "";

  quizzes.forEach(q => {
    tbody.innerHTML += `
      <tr>
        <td>${q.topic || q.title}</td>
        <td>${q.score}</td>
        <td>${q.total}</td>
        <td>${q.percentage}%</td>
        <td>${q.date}</td>
      </tr>
    `;
  });

  renderSummary(quizzes, "quizSummary", "Quiz");
}

/* ================= CBT ================= */
function renderCBT(){
  const tbody = document.querySelector("#cbtTable tbody");
  tbody.innerHTML = "";

  cbts.forEach(c => {
    tbody.innerHTML += `
      <tr>
        <td>${c.subjects || "Unknown"}</td>
        <td>${c.score}</td>
        <td>${c.total}</td>
        <td>${c.percentage}%</td>
        <td>${c.date}</td>
      </tr>
    `;
  });

  renderSummary(cbts, "cbtSummary", "CBT");
}

/* ================= SUMMARY ================= */
function renderSummary(records, containerId, type){
  const box = document.getElementById(containerId);
  if (!records.length) {
    box.innerHTML = "<p style='color:#666'>No records yet</p>";
    return;
  }

  const p = records.map(r => parseFloat(r.percentage) || 0);
  box.innerHTML = `
    <div class="summary-card"><h3>Total ${type}s</h3><p>${records.length}</p></div>
    <div class="summary-card"><h3>Average</h3><p>${(p.reduce((a,b)=>a+b,0)/p.length).toFixed(1)}%</p></div>
    <div class="summary-card"><h3>Best</h3><p>${Math.max(...p)}%</p></div>
    <div class="summary-card"><h3>Lowest</h3><p>${Math.min(...p)}%</p></div>
  `;
}

/* ================= CHARTS ================= */
let quizChartInstance, cbtChartInstance;

function renderQuizChart(){
  if (!quizzes.length) return;
  if (quizChartInstance) quizChartInstance.destroy();

  quizChartInstance = new Chart(
    document.getElementById("quizChart"),
    {
      type: "bar",
      data: {
        labels: quizzes.map((_, i) => `Quiz ${i + 1}`),
        datasets: [{
          label: "Percentage",
          data: quizzes.map(q => q.percentage),
          backgroundColor: "#8B0000"
        }]
      }
    }
  );
}

function renderCBTChart(){
  if (!cbts.length) return;
  if (cbtChartInstance) cbtChartInstance.destroy();

  cbtChartInstance = new Chart(
    document.getElementById("cbtChart"),
    {
      type: "line",
      data: {
        labels: cbts.map((_, i) => `CBT ${i + 1}`),
        datasets: [{
          label: "Percentage",
          data: cbts.map(c => c.percentage),
          borderColor: "#8B0000",
          fill: false
        }]
      }
    }
  );
}

/* ================= CLEAR ================= */
function clearAllRecords(){
  if (confirm("Clear all records?")) {
    localStorage.removeItem("quizResults");
    localStorage.removeItem("cbtResults");
    localStorage.removeItem("aplus_completed_topics_v2");
    localStorage.removeItem("aplus_topic_progress_v2");
    location.reload();
  }
}

/* ================= PDF ================= */
function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 15;
  doc.setFontSize(18);
  doc.text("Aplus Tutors ‚Äì Progress Report", 10, y);

  doc.setFontSize(11);
  y += 10;
  doc.text(`Student: ${user.fullName}`, 10, y);
  y += 6;
  doc.text(`Department: ${user.department}`, 10, y);

  function addTable(title, id){
    y += 10;
    doc.setFontSize(14);
    doc.text(title, 10, y);
    y += 6;
    doc.setFontSize(10);

    document.querySelectorAll(`#${id} tbody tr`).forEach(r => {
      const text = Array.from(r.children).map(c => c.textContent).join(" | ");
      doc.text(text, 10, y);
      y += 6;
      if (y > 280) { doc.addPage(); y = 15; }
    });
  }

  addTable("Study Progress", "studyTable");
  addTable("Quiz Records", "quizTable");
  addTable("CBT Records", "cbtTable");

  doc.save("Aplus_Progress_Report.pdf");
}

/* ================= INIT ================= */
renderStudy();
renderQuiz();
renderCBT();
renderQuizChart();
renderCBTChart();
</script>

</body>
</html>