<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplus Tutors | Progress Tracker</title>
  <link rel="stylesheet" href="progress.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <header>
    <h1>My Progress</h1>
    <div class="student-info">
      <p><strong>Name:</strong> <span id="studentName"></span></p>
      <p><strong>Email:</strong> <span id="studentEmail"></span></p>
    </div>
  </header>

  <main>
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" id="quizTab" onclick="showSection('quiz')">Quizzes</button>
      <button class="tab" id="cbtTab" onclick="showSection('cbt')">CBT Tests</button>
    </div>

    <!-- QUIZ SECTION -->
    <section id="quizSection" class="content-section active">
      <h2>Quiz Records</h2>
      <div class="summary-container" id="quizSummary"></div>
      <div class="chart-container">
        <canvas id="quizChart"></canvas>
      </div>

      <div class="table-wrapper">
        <table id="quizTable">
          <thead>
            <tr>
              <th>Title</th>
              <th>Score</th>
              <th>Total</th>
              <th>Percentage</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- CBT SECTION -->
    <section id="cbtSection" class="content-section">
      <h2>CBT Records</h2>
      <div class="summary-container" id="cbtSummary"></div>
      <div class="chart-container">
        <canvas id="cbtChart"></canvas>
      </div>

      <div class="table-wrapper">
        <table id="cbtTable">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Score</th>
              <th>Total</th>
              <th>Percentage</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <button class="clear-btn" onclick="clearProgress()">Clear All Records</button>
    <button class="back-btn" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
  </footer>

  <script>
    // Load user info
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (user) {
      document.getElementById("studentName").textContent = user.fullName;
      document.getElementById("studentEmail").textContent = user.email;
    } else {
      window.location.href = "index.html";
    }

    // Load data
    const quizResults = JSON.parse(localStorage.getItem("quizResults")) || [];
    const cbtResults = JSON.parse(localStorage.getItem("cbtResults")) || [];

    // Filter data by logged-in user
    const myQuizzes = quizResults.filter(q => q.email === user.email);
    const myCBTs = cbtResults.filter(c => c.email === user.email);

    // Build tables
    const quizTable = document.querySelector("#quizTable tbody");
    myQuizzes.forEach(q => {
      quizTable.innerHTML += `
        <tr>
          <td>${q.topic || q.title || "—"}</td>
          <td>${q.score}</td>
          <td>${q.total}</td>
          <td>${parseFloat(q.percentage) || q.percentage}%</td>
          <td>${q.date}</td>
        </tr>`;
    });

    const cbtTable = document.querySelector("#cbtTable tbody");
    myCBTs.forEach(c => {
      cbtTable.innerHTML += `
        <tr>
          <td>${c.subject || "—"}</td>
          <td>${c.score}</td>
          <td>${c.total}</td>
          <td>${parseFloat(c.percentage) || c.percentage}%</td>
          <td>${c.date}</td>
        </tr>`;
    });

    // Summary card generator
    function renderSummary(records, containerId, type) {
      const container = document.getElementById(containerId);
      if (records.length === 0) {
        container.innerHTML = "<p class='no-data'>No records available yet.</p>";
        return;
      }

      const totalTaken = records.length;
      const percents = records.map(r => parseFloat(r.percentage) || 0);
      const average = (percents.reduce((sum, p) => sum + p, 0) / totalTaken).toFixed(1);
      const best = Math.max(...percents);
      const worst = Math.min(...percents);

      container.innerHTML = `
        <div class="summary-card"><h3>Total ${type}s Taken</h3><p>${totalTaken}</p></div>
        <div class="summary-card"><h3>Average Score</h3><p>${average}%</p></div>
        <div class="summary-card"><h3>Best Performance</h3><p>${best}%</p></div>
        <div class="summary-card"><h3>Lowest Performance</h3><p>${worst}%</p></div>`;
    }

    renderSummary(myQuizzes, "quizSummary", "Quiz");
    renderSummary(myCBTs, "cbtSummary", "CBT");

    // Tabs
    function showSection(type) {
      document.querySelectorAll(".content-section").forEach(sec => sec.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      if (type === "quiz") {
        document.getElementById("quizSection").classList.add("active");
        document.getElementById("quizTab").classList.add("active");
      } else {
        document.getElementById("cbtSection").classList.add("active");
        document.getElementById("cbtTab").classList.add("active");
      }
    }

    // Clear all data
    function clearProgress() {
      if (confirm("Are you sure you want to clear all your progress records?")) {
        localStorage.removeItem("quizResults");
        localStorage.removeItem("cbtResults");
        location.reload();
      }
    }

    // Charts
    if (myQuizzes.length > 0) {
      new Chart(document.getElementById("quizChart"), {
        type: "bar",
        data: {
          labels: myQuizzes.map(q => q.topic || q.title || "Quiz"),
          datasets: [{
            label: "Quiz Performance (%)",
            data: myQuizzes.map(q => parseFloat(q.percentage) || 0),
            backgroundColor: "rgba(139, 20, 20, 0.6)",
            borderColor: "crimson",
            borderWidth: 1
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }

    if (myCBTs.length > 0) {
      new Chart(document.getElementById("cbtChart"), {
        type: "line",
        data: {
          labels: myCBTs.map(c => c.subject || "CBT"),
          datasets: [{
            label: "CBT Performance (%)",
            data: myCBTs.map(c => parseFloat(c.percentage) || 0),
            borderColor: "crimson",
            backgroundColor: "rgba(139, 20, 20, 0.3)",
            borderWidth: 2,
            tension: 0.4
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }
  </script>
</body>
</html>