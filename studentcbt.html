<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aplus Tutors | CBT Test</title>
  <link rel="stylesheet" href="cbt.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <div id="login-section">
    <h2>CBT Access</h2>
    <div class="student-info">
      <h3><strong>Welcome back, </strong> <span id="student-name"></span></h3>
    </div>

    <label>Select Subjects (1â€“4):</label>
    <select id="subject-select" multiple></select>

    <label>Set Test Duration (minutes):</label>
    <input type="number" id="duration" placeholder="e.g. 45" min="1" max="180">

    <label>Number of Questions per Subject:</label>
    <input type="number" id="num-questions" placeholder="e.g. 20" min="1" max="100">

    <button id="login-btn">Start Test</button>
    <p id="login-error" class="error"></p>
  </div>

  <div id="cbt-section" class="hidden">
    <header>
      <div id="subject-nav"></div>
      <div class="timer" id="timer">00:00</div>
    </header>

    <main style="padding: 20px;" id="question-area">
      <h3 id="question-number"></h3>
      <img id="question-image" class="hidden" alt="Question image">
      <p id="question-text"></p>
      <div id="options"></div>

      <div class="controls">
        <button id="prev-btn">Previous</button>
        <button style="background-color: darkgreen;" id="submit-btn">Submit</button>
        <button id="next-btn">Next</button>
      </div>

      <div class="question-nav" id="question-nav"></div>
    </main>

    <section style="padding: 20px;" id="result-section" class="hidden">
      <h2>Result Summary</h2>
      <canvas id="resultChart"></canvas>
      <p id="score-text"></p>
      <div id="subject-stats"></div>

      <button id="download-btn">Download Result</button>
      <button id="email-btn">Send to Instructor</button>
      <button id="view-corrections-btn">View Corrections</button>
      <button style="background-color: black;">
        <a style="text-decoration-line: none; color: white;" href="dashboard.html">Back to Dashboard</a>
      </button>
    </section>

    <section style="padding: 20px;" id="correction-section" class="hidden">
      <h2>Corrections</h2>
      <div id="corrections-container"></div>
      <button id="back-to-result-btn">Back to Result</button>
    </section>
  </div>

  <!-- Firebase tracking -->
  <script src="firebase-init.js"></script>
  <script src="cbtdata.js"></script>
  <script>
let currentUser, selectedSubjects = [], currentSubject, currentQuestionIndex = 0;
let userAnswers = {}, timerInterval, activeQuestions = {};

const loginBtn = document.getElementById("login-btn");
const loginError = document.getElementById("login-error");
const subjectSelect = document.getElementById("subject-select");

// Load user info & subjects
window.addEventListener("load", () => {
  const storedUser = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!storedUser) {
    alert("You must log in first!");
    window.location.href = "index.html";
    return;
  }
  currentUser = storedUser;
  document.getElementById("student-name").textContent = currentUser.fullName;

  subjects.forEach(sub => {
    const opt = document.createElement("option");
    opt.textContent = sub;
    subjectSelect.appendChild(opt);
  });
});

// Start Test
loginBtn.onclick = () => {
  const duration = parseInt(document.getElementById("duration").value);
  const numQuestions = parseInt(document.getElementById("num-questions").value);

  selectedSubjects = Array.from(subjectSelect.selectedOptions).map(o => o.value);
  if (selectedSubjects.length === 0 || selectedSubjects.length > 4) {
    loginError.textContent = "Select between 1 and 4 subjects.";
    return;
  }
  if (isNaN(duration) || duration <= 0) {
    loginError.textContent = "Please enter a valid duration.";
    return;
  }
  if (isNaN(numQuestions) || numQuestions <= 0) {
    loginError.textContent = "Please enter valid number of questions.";
    return;
  }

  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("cbt-section").classList.remove("hidden");

  const subjectNav = document.getElementById("subject-nav");
  subjectNav.innerHTML = "";

  selectedSubjects.forEach(sub => {
    let qList = [...questions[sub]];
    qList = shuffleArray(qList);
    if (numQuestions < qList.length) qList = qList.slice(0, numQuestions);
    activeQuestions[sub] = qList;

    const btn = document.createElement("button");
    btn.textContent = sub;
    btn.classList.add("subject-btn");
    btn.onclick = () => switchSubject(sub);
    subjectNav.appendChild(btn);

    if (!userAnswers[sub]) userAnswers[sub] = {};
  });

  currentSubject = selectedSubjects[0];
  currentQuestionIndex = 0;
  startTimer(duration);
  loadQuestion();

  // Track CBT start
  try { trackEvent({ user: currentUser.fullName, subjects: selectedSubjects.join(",") }, "cbt_start"); } catch(err){ console.error(err); }
};

// Shuffle helper
function shuffleArray(array) {
  let arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Timer
function startTimer(minutes) {
  let time = minutes * 60;
  timerInterval = setInterval(() => {
    const mins = Math.floor(time / 60);
    const secs = time % 60;
    document.getElementById("timer").textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    if (time <= 0) {
      clearInterval(timerInterval);
      alert("Time up! Submitting test...");
      showResult();
    }
    time--;
  }, 1000);
}

// Switch subjects
function switchSubject(sub) {
  currentSubject = sub;
  currentQuestionIndex = 0;
  loadQuestion();
}

// Load question
function loadQuestion() {
  const q = activeQuestions[currentSubject][currentQuestionIndex];
  document.getElementById("question-number").textContent = `${currentSubject}: Question ${currentQuestionIndex + 1}`;
  document.getElementById("question-text").innerHTML = q.question;

  const qImg = document.getElementById("question-image");
  if (q.image) { qImg.src = q.image; qImg.alt = q.imageAlt || "Question image"; qImg.classList.remove("hidden"); }
  else { qImg.classList.add("hidden"); qImg.removeAttribute("src"); }

  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";
  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.innerHTML = opt;
    btn.classList.add("option");
    btn.onclick = () => selectAnswer(i);
    if (userAnswers[currentSubject]?.[currentQuestionIndex] === i) btn.classList.add("selected");
    optionsDiv.appendChild(btn);
  });

  updateQuestionNav();
}

// Select answer
function selectAnswer(i) {
  if (!userAnswers[currentSubject]) userAnswers[currentSubject] = {};
  userAnswers[currentSubject][currentQuestionIndex] = i;

  const buttons = document.querySelectorAll("#options button");
  buttons.forEach((btn, idx) => btn.classList.toggle("selected", idx === i));
}

// Navigation
document.getElementById("next-btn").onclick = () => {
  if (currentQuestionIndex < activeQuestions[currentSubject].length - 1) currentQuestionIndex++;
  loadQuestion();
};
document.getElementById("prev-btn").onclick = () => {
  if (currentQuestionIndex > 0) currentQuestionIndex--;
  loadQuestion();
};
document.getElementById("submit-btn").onclick = () => {
  const unanswered = countUnanswered();
  if (unanswered > 0 && !confirm(`${unanswered} unanswered. Submit anyway?`)) return;
  showResult();
};

// Question nav
function updateQuestionNav() {
  const nav = document.getElementById("question-nav");
  nav.innerHTML = "";
  activeQuestions[currentSubject].forEach((_, i) => {
    const btn = document.createElement("button");
    btn.textContent = i + 1;
    btn.classList.add("nav-btn");
    if (userAnswers[currentSubject]?.[i] !== undefined) btn.classList.add("answered");
    if (i === currentQuestionIndex) btn.classList.add("active");
    btn.onclick = () => { currentQuestionIndex = i; loadQuestion(); };
    nav.appendChild(btn);
  });
}

// Count unanswered
function countUnanswered() {
  let count = 0;
  selectedSubjects.forEach(sub => {
    activeQuestions[sub].forEach((_, i) => {
      if (userAnswers[sub]?.[i] === undefined) count++;
    });
  });
  return count;
}

// Results + Corrections
function showResult() {
  clearInterval(timerInterval);
  document.getElementById("question-area").classList.add("hidden");
  document.getElementById("result-section").classList.remove("hidden");

  let totalCorrect = 0, totalQuestions = 0;
  const subjectStats = [];

  selectedSubjects.forEach(sub => {
    let correct = 0;
    const total = activeQuestions[sub].length;
    activeQuestions[sub].forEach((q, i) => {
      if (userAnswers[sub]?.[i] === q.answer) correct++;
    });
    totalCorrect += correct;
    totalQuestions += total;
    subjectStats.push({ subject: sub, correct, total, percent: ((correct / total) * 100).toFixed(1) });
  });

  const overallPercent = ((totalCorrect / totalQuestions) * 100).toFixed(1);
  document.getElementById("score-text").innerHTML = `Overall Score: ${totalCorrect}/${totalQuestions} (${overallPercent}%)`;

  const statsDiv = document.getElementById("subject-stats");
  statsDiv.innerHTML = `<h3>Subject Breakdown</h3>
    <table>
      <tr><th>Subject</th><th>Correct</th><th>Total</th><th>Percentage</th></tr>
      ${subjectStats.map(s => `<tr><td>${s.subject}</td><td>${s.correct}</td><td>${s.total}</td><td>${s.percent}%</td></tr>`).join("")}
    </table>`;

  new Chart(document.getElementById("resultChart"), {
    type: "pie",
    data: { labels: ["Correct", "Incorrect"], datasets: [{ data: [totalCorrect, totalQuestions - totalCorrect], backgroundColor: ["green", "red"] }] },
  });

  const date = new Date().toLocaleString();
  const cbtRecords = JSON.parse(localStorage.getItem("cbtResults")) || [];
  cbtRecords.push({ name: currentUser.fullName, email: currentUser.email, subjects: selectedSubjects.join(", "), score: totalCorrect, total: totalQuestions, percentage: overallPercent, date });
  localStorage.setItem("cbtResults", JSON.stringify(cbtRecords));

  // Track CBT submission
  try { trackEvent({ user: currentUser.fullName, score: totalCorrect, total: totalQuestions, percentage: overallPercent }, "cbt_submission"); } catch(err){ console.error(err); }
}

// Show corrections
function showCorrections() {
  document.getElementById("result-section").classList.add("hidden");
  document.getElementById("correction-section").classList.remove("hidden");
  const container = document.getElementById("corrections-container");
  container.innerHTML = "";

  selectedSubjects.forEach(sub => {
    const subHeader = document.createElement("h3");
    subHeader.textContent = sub;
    container.appendChild(subHeader);

    activeQuestions[sub].forEach((q, i) => {
      const div = document.createElement("div");
      div.classList.add("correction-item");
      const imgHTML = q.image ? `<img src="${q.image}" class="correction-image" alt="Question image">` : "";
      const userAns = userAnswers[sub]?.[i];
      const correctAns = q.answer;
      const userAnswerText = userAns !== undefined ? q.options[userAns] : "No answer selected";
      const correctAnswerText = q.options[correctAns];
      div.innerHTML = `<p><strong>Q${i+1}:</strong> ${q.question}</p>${imgHTML}<p>Your Answer: <span class="user-answer ${userAns===undefined?'unanswered':(userAns===correctAns?'correct':'wrong')}">${userAnswerText}</span></p><p>Correct Answer: <span class="correct">${correctAnswerText}</span></p>`;
      container.appendChild(div);
    });
  });

  document.getElementById("back-to-result-btn").onclick = () => {
    document.getElementById("correction-section").classList.add("hidden");
    document.getElementById("result-section").classList.remove("hidden");
  };
}

// Attach the corrections button event
document.getElementById("view-corrections-btn").onclick = showCorrections;
  </script>
</body>
</html>